(function() {
  'use strict';
  var cache, commonDatas, defaultLang, extend, i18n, pageDatas, translationsPath;
  defaultLang = 'en_US';
  i18n = false;
  translationsPath = false;
  pageDatas = false;
  commonDatas = {};
  cache = {};
  extend = function(object, properties) {
    var key, val;
    for (key in properties) {
      val = properties[key];
      object[key] = val;
    }
    return object;
  };
  angular.module('jed', []);
  angular.module('jed').factory('i18n', [
    '$http', '$rootScope', '$q', function($http, $rootScope, $q) {
      var get, jed, readyDeferred, setI18N;
      readyDeferred = $q.defer();
      get = function(file) {
        var deferred, varName;
        deferred = $q.defer();
        varName = file.replace('.json', '');
        if (window.translations && window.translations[varName]) {
          deferred.resolve(JSON.parse(window.translations[varName]));
        } else if (file in cache) {
          deferred.resolve(cache[file]);
        } else {
          $http.get("" + translationsPath + "/" + file).success(function(data) {
            cache[file] = data;
            return deferred.resolve(data);
          }).error(function() {
            return deferred.reject();
          });
        }
        return deferred.promise;
      };
      setI18N = function(data) {
        if (data == null) {
          data = false;
        }
        i18n = data ? new Jed(data) : void 0;
        $rootScope._ = function(key) {
          return jed._(key);
        };
        return $rootScope._n = function(singular_key, plural_key, value) {
          return jed._n(singular_key, plural_key, value);
        };
      };
      return jed = {
        setTranslationPath: function(path) {
          translationsPath = path;
          return jed;
        },
        setLang: function(value) {
          var lang;
          lang = value;
          return jed;
        },
        setDefaultLang: function(lang) {
          defaultLang = lang;
          return jed;
        },
        loadCommon: function(common) {
          var deferred;
          deferred = $q.defer();
          get("" + common + "-" + lang + ".json").then(function(data) {
            commonDatas = extend(commonDatas, data.locale_data.messages);
            if (pageDatas) {
              pageDatas.locale_data.messages = extend(pageDatas.locale_data.messages, commonDatas);
              setI18N(pageDatas);
            } else {
              setI18N(data);
            }
            readyDeferred.resolve();
            return deferred.resolve();
          }, function() {
            readyDeferred.resolve();
            return deferred.resolve();
          });
          return deferred.promise;
        },
        loadPage: function(page) {
          var deferred;
          deferred = $q.defer();
          get("" + page + "-" + lang + ".json").then(function(data) {
            data.locale_data.messages = extend(data.locale_data.messages, commonDatas);
            pageDatas = data;
            setI18N(data);
            readyDeferred.resolve();
            return deferred.resolve();
          }, function() {
            if (lang === defaultLang) {
              setI18N();
            } else {
              jed.loadPage(page);
            }
            readyDeferred.resolve();
            return deferred.resolve();
          });
          return deferred.promise;
        },
        _: function(key) {
          if (i18n) {
            return i18n.gettext(key);
          } else {
            return key;
          }
        },
        _n: function(singular_key, plural_key, value) {
          if (i18n) {
            return i18n.ngettext(singular_key, plural_key, value);
          } else {
            if (value === 1) {
              return singular_key;
            } else {
              return plural_key;
            }
          }
        },
        ready: function() {
          return readyDeferred.promise;
        }
      };
    }
  ]);
  return angular.module('jed').directive('trans', [
    'i18n', function(i18n) {
      return {
        restrict: 'E',
        replace: true,
        scope: {
          singular: '@',
          plural: '@',
          none: '@',
          count: '=',
          placeholders: '='
        },
        template: '<span>{{ result }}</span>',
        controller: function($scope, $element) {
          var key, name, ready, render, watchObjects, _count, _placeholders, _ref;
          ready = false;
          _.templateSettings.interpolate = /%([\s\S]+?)%/g;
          _placeholders = {};
          _count = 0;
          i18n.ready().then(function() {
            ready = true;
            return render(_count, _placeholders);
          });
          render = function(count, placeholders) {
            var result;
            _count = count;
            _placeholders = placeholders;
            if (!ready) {
              return;
            }
            if ($scope.count.toString() === '0' && $scope.none) {
              result = i18n._($scope.none);
            } else {
              result = i18n._n($scope.singular, $scope.plural, count);
            }
            return $scope.result = _.template(result, placeholders);
          };
          watchObjects = ['count'];
          _ref = Object.keys($scope.placeholders);
          for (key in _ref) {
            name = _ref[key];
            watchObjects.push("placeholders." + name);
          }
          return $scope.$watchGroup(watchObjects, function() {
            if (typeof parseInt($scope.count) !== 'number' || $scope.count === '') {
              return;
            }
            return render($scope.count, $scope.placeholders);
          });
        }
      };
    }
  ]);
})();

//# sourceMappingURL=data:application/json;base64,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RjtBQUFBLFdBckJBO2lCQXdCQSxNQUFNLENBQUMsV0FBUCxDQUFtQixZQUFuQixFQUFpQyxTQUFBLEdBQUE7QUFDL0IsWUFBQSxJQUFHLE1BQUEsQ0FBQSxRQUFPLENBQVMsTUFBTSxDQUFDLEtBQWhCLENBQVAsS0FBaUMsUUFBakMsSUFBNkMsTUFBTSxDQUFDLEtBQVAsS0FBZ0IsRUFBaEU7QUFDRSxvQkFBQSxDQURGO2FBQUE7bUJBR0EsTUFBQSxDQUFPLE1BQU0sQ0FBQyxLQUFkLEVBQXFCLE1BQU0sQ0FBQyxZQUE1QixFQUorQjtVQUFBLENBQWpDLEVBekJVO1FBQUEsQ0FUWjtPQURGLENBREY7SUFBQSxDQUZ1QztHQUF6QyxFQXBIRDtBQUFBLENBQUQsQ0FBQSxDQUFBLENBQUEsQ0FBQSIsImZpbGUiOiJhbmd1bGFyLWplZC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIigtPlxuICAndXNlIHN0cmljdCdcblxuICBkZWZhdWx0TGFuZyA9ICdlbl9VUydcbiAgaTE4biA9IGZhbHNlXG4gIHRyYW5zbGF0aW9uc1BhdGggPSBmYWxzZVxuICBwYWdlRGF0YXMgPSBmYWxzZVxuICBjb21tb25EYXRhcyA9IHt9XG4gIGNhY2hlID0ge31cblxuICBleHRlbmQgPSAob2JqZWN0LCBwcm9wZXJ0aWVzKSAtPlxuICAgIGZvciBrZXksIHZhbCBvZiBwcm9wZXJ0aWVzXG4gICAgICBvYmplY3Rba2V5XSA9IHZhbFxuICAgIG9iamVjdFxuXG4gIGFuZ3VsYXIubW9kdWxlICdqZWQnLCBbXVxuXG4gIGFuZ3VsYXIubW9kdWxlKCdqZWQnKS5mYWN0b3J5ICdpMThuJywgW1xuICAgICckaHR0cCdcbiAgICAnJHJvb3RTY29wZSdcbiAgICAnJHEnXG4gICAgKCRodHRwLCAkcm9vdFNjb3BlLCAkcSkgLT5cbiAgICAgIHJlYWR5RGVmZXJyZWQgPSAkcS5kZWZlcigpXG5cbiAgICAgICMgR2V0IGEgdHJhbnNsYXRpb24gZmlsZSBmcm9tIGNhY2hlIG9yIGFqYXhcbiAgICAgIGdldCA9IChmaWxlKSAtPlxuICAgICAgICBkZWZlcnJlZCA9ICRxLmRlZmVyKClcbiAgICAgICAgdmFyTmFtZSA9IGZpbGUucmVwbGFjZSgnLmpzb24nLCAnJylcbiAgICAgICAgaWYgd2luZG93LnRyYW5zbGF0aW9ucyBhbmQgd2luZG93LnRyYW5zbGF0aW9uc1t2YXJOYW1lXVxuICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoSlNPTi5wYXJzZSB3aW5kb3cudHJhbnNsYXRpb25zW3Zhck5hbWVdKVxuICAgICAgICBlbHNlIGlmIGZpbGUgb2YgY2FjaGVcbiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGNhY2hlW2ZpbGVdKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgJGh0dHAuZ2V0KFwiI3t0cmFuc2xhdGlvbnNQYXRofS8je2ZpbGV9XCIpXG4gICAgICAgICAgICAuc3VjY2VzcyAoZGF0YSkgLT5cbiAgICAgICAgICAgICAgY2FjaGVbZmlsZV0gPSBkYXRhXG4gICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGF0YSlcbiAgICAgICAgICAgIC5lcnJvciAtPlxuICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoKVxuICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxuXG4gICAgICAjIEluaXRpYWxpemUgSmVkXG4gICAgICBzZXRJMThOID0gKGRhdGEgPSBmYWxzZSkgLT5cbiAgICAgICAgaTE4biA9IGlmIGRhdGEgdGhlbiBuZXcgSmVkKGRhdGEpXG5cbiAgICAgICAgJHJvb3RTY29wZS5fID0gKGtleSkgLT5cbiAgICAgICAgICBqZWQuXyhrZXkpXG5cbiAgICAgICAgJHJvb3RTY29wZS5fbiA9IChzaW5ndWxhcl9rZXksIHBsdXJhbF9rZXksIHZhbHVlKSAtPlxuICAgICAgICAgIGplZC5fbihzaW5ndWxhcl9rZXksIHBsdXJhbF9rZXksIHZhbHVlKVxuXG4gICAgICAjIFB1YmxpYyBBUElcbiAgICAgIGplZCA9XG4gICAgICAgIHNldFRyYW5zbGF0aW9uUGF0aDogKHBhdGgpIC0+XG4gICAgICAgICAgdHJhbnNsYXRpb25zUGF0aCA9IHBhdGhcbiAgICAgICAgICBqZWRcblxuICAgICAgICBzZXRMYW5nOiAodmFsdWUpIC0+XG4gICAgICAgICAgbGFuZyA9IHZhbHVlXG4gICAgICAgICAgamVkXG5cbiAgICAgICAgc2V0RGVmYXVsdExhbmc6IChsYW5nKSAtPlxuICAgICAgICAgIGRlZmF1bHRMYW5nID0gbGFuZ1xuICAgICAgICAgIGplZFxuXG4gICAgICAgICMgTG9hZCBjb21tb24gdHJhbnNsYXRpb25zXG4gICAgICAgIGxvYWRDb21tb246IChjb21tb24pIC0+XG4gICAgICAgICAgZGVmZXJyZWQgPSAkcS5kZWZlcigpXG4gICAgICAgICAgZ2V0KFwiI3tjb21tb259LSN7bGFuZ30uanNvblwiKS50aGVuKChkYXRhKSAtPlxuICAgICAgICAgICAgIyBub3Qgc3VyZSB0aGlzIGlzIG5lZWRlZCB0aG9cbiAgICAgICAgICAgIGNvbW1vbkRhdGFzID0gZXh0ZW5kIGNvbW1vbkRhdGFzLCBkYXRhLmxvY2FsZV9kYXRhLm1lc3NhZ2VzXG4gICAgICAgICAgICBpZiBwYWdlRGF0YXNcbiAgICAgICAgICAgICAgcGFnZURhdGFzLmxvY2FsZV9kYXRhLm1lc3NhZ2VzID0gZXh0ZW5kIHBhZ2VEYXRhcy5sb2NhbGVfZGF0YS5tZXNzYWdlcywgY29tbW9uRGF0YXNcbiAgICAgICAgICAgICAgc2V0STE4TiBwYWdlRGF0YXNcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgc2V0STE4TiBkYXRhXG4gICAgICAgICAgICByZWFkeURlZmVycmVkLnJlc29sdmUoKVxuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpXG4gICAgICAgICAgLCAtPlxuICAgICAgICAgICAgcmVhZHlEZWZlcnJlZC5yZXNvbHZlKClcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKVxuICAgICAgICAgIClcbiAgICAgICAgICBkZWZlcnJlZC5wcm9taXNlXG5cbiAgICAgICAgIyBMb2FkIHBhZ2UgdHJhbnNsYXRpb25cbiAgICAgICAgbG9hZFBhZ2U6IChwYWdlKSAtPlxuICAgICAgICAgIGRlZmVycmVkID0gJHEuZGVmZXIoKVxuICAgICAgICAgIGdldChcIiN7cGFnZX0tI3tsYW5nfS5qc29uXCIpLnRoZW4oKGRhdGEpIC0+XG4gICAgICAgICAgICBkYXRhLmxvY2FsZV9kYXRhLm1lc3NhZ2VzID0gZXh0ZW5kIGRhdGEubG9jYWxlX2RhdGEubWVzc2FnZXMsIGNvbW1vbkRhdGFzXG4gICAgICAgICAgICBwYWdlRGF0YXMgPSBkYXRhXG4gICAgICAgICAgICBzZXRJMThOIGRhdGFcbiAgICAgICAgICAgIHJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpXG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKClcbiAgICAgICAgICAsIC0+XG4gICAgICAgICAgICBpZiBsYW5nID09IGRlZmF1bHRMYW5nXG4gICAgICAgICAgICAgIHNldEkxOE4oKVxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICBqZWQubG9hZFBhZ2UocGFnZSlcbiAgICAgICAgICAgIHJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpXG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKClcbiAgICAgICAgICApXG4gICAgICAgICAgZGVmZXJyZWQucHJvbWlzZVxuXG4gICAgICAgIF86IChrZXkpIC0+XG4gICAgICAgICAgaWYgaTE4biB0aGVuIGkxOG4uZ2V0dGV4dChrZXkpIGVsc2Uga2V5XG5cbiAgICAgICAgX246IChzaW5ndWxhcl9rZXksIHBsdXJhbF9rZXksIHZhbHVlKSAtPlxuICAgICAgICAgIGlmIGkxOG5cbiAgICAgICAgICAgIGkxOG4ubmdldHRleHQgc2luZ3VsYXJfa2V5LCBwbHVyYWxfa2V5LCB2YWx1ZVxuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgIGlmIHZhbHVlID09IDEgdGhlbiBzaW5ndWxhcl9rZXkgZWxzZSBwbHVyYWxfa2V5XG5cbiAgICAgICAgcmVhZHk6IC0+XG4gICAgICAgICAgcmVhZHlEZWZlcnJlZC5wcm9taXNlXG4gIF1cblxuICBhbmd1bGFyLm1vZHVsZSgnamVkJykuZGlyZWN0aXZlICd0cmFucycsIFtcbiAgICAnaTE4bidcbiAgICAoaTE4bikgLT5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIHJlc3RyaWN0OiAnRSdcbiAgICAgICAgcmVwbGFjZTogdHJ1ZVxuICAgICAgICBzY29wZTpcbiAgICAgICAgICBzaW5ndWxhcjogJ0AnXG4gICAgICAgICAgcGx1cmFsOiAnQCdcbiAgICAgICAgICBub25lOiAnQCdcbiAgICAgICAgICBjb3VudDogJz0nXG4gICAgICAgICAgcGxhY2Vob2xkZXJzOiAnPSdcbiAgICAgICAgdGVtcGxhdGU6ICc8c3Bhbj57eyByZXN1bHQgfX08L3NwYW4+J1xuICAgICAgICBjb250cm9sbGVyOiAoJHNjb3BlLCAkZWxlbWVudCkgLT5cbiAgICAgICAgICByZWFkeSA9IGZhbHNlXG4gICAgICAgICAgXy50ZW1wbGF0ZVNldHRpbmdzLmludGVycG9sYXRlID0gLyUoW1xcc1xcU10rPyklL2c7XG4gICAgICAgICAgX3BsYWNlaG9sZGVycyA9IHt9XG4gICAgICAgICAgX2NvdW50ID0gMFxuXG4gICAgICAgICAgaTE4bi5yZWFkeSgpLnRoZW4gLT5cbiAgICAgICAgICAgIHJlYWR5ID0gdHJ1ZVxuICAgICAgICAgICAgcmVuZGVyKF9jb3VudCwgX3BsYWNlaG9sZGVycylcblxuICAgICAgICAgIHJlbmRlciA9IChjb3VudCwgcGxhY2Vob2xkZXJzKSAtPlxuICAgICAgICAgICAgX2NvdW50ID0gY291bnRcbiAgICAgICAgICAgIF9wbGFjZWhvbGRlcnMgPSBwbGFjZWhvbGRlcnNcbiAgICAgICAgICAgIHJldHVybiB1bmxlc3MgcmVhZHlcbiAgICAgICAgICAgIGlmICRzY29wZS5jb3VudC50b1N0cmluZygpID09ICcwJyBhbmQgJHNjb3BlLm5vbmVcbiAgICAgICAgICAgICAgcmVzdWx0ID0gaTE4bi5fICRzY29wZS5ub25lXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgIHJlc3VsdCA9IGkxOG4uX24gJHNjb3BlLnNpbmd1bGFyLCAkc2NvcGUucGx1cmFsLCBjb3VudFxuICAgICAgICAgICAgJHNjb3BlLnJlc3VsdCA9IF8udGVtcGxhdGUocmVzdWx0LCBwbGFjZWhvbGRlcnMpXG5cbiAgICAgICAgICB3YXRjaE9iamVjdHMgPSBbJ2NvdW50J11cblxuICAgICAgICAgIGZvciBrZXksIG5hbWUgb2YgT2JqZWN0LmtleXMoJHNjb3BlLnBsYWNlaG9sZGVycylcbiAgICAgICAgICAgIHdhdGNoT2JqZWN0cy5wdXNoIFwicGxhY2Vob2xkZXJzLiN7bmFtZX1cIlxuXG4gICAgICAgICAgJHNjb3BlLiR3YXRjaEdyb3VwKHdhdGNoT2JqZWN0cywgLT5cbiAgICAgICAgICAgIGlmIHR5cGVvZiBwYXJzZUludCgkc2NvcGUuY291bnQpICE9ICdudW1iZXInIG9yICRzY29wZS5jb3VudCA9PSAnJ1xuICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAgICAgcmVuZGVyKCRzY29wZS5jb3VudCwgJHNjb3BlLnBsYWNlaG9sZGVycylcbiAgICAgICAgICApXG4gICAgICApXG4gIF1cbikoKVxuIl19